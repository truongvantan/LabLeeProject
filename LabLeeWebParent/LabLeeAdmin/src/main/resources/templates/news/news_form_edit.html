<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<head th:replace="~{fragments :: page_head('Edit news', 'tag')}" />
<script
	src="https://cdn.tiny.cloud/1/23v8b65dspuhtpforj308ya1cib61htuo5l3sd5j8f328t4y/tinymce/6/tinymce.min.js"
	referrerpolicy="origin"
></script>
<meta
	name="_csrf"
	th:content="${_csrf.token}"
/>
<meta
	name="_csrf_header"
	th:content="${_csrf.headerName}"
/>
</head>
<body>
	<div class="container-fluid">
		<div th:replace="~{navigation::menu}"></div>
		<h1 class="text-center mt-5">Edit news ID ([[${newsFormEditDTO.id}]])</h1>
		<div th:replace="~{fragments::alert_message_box}"></div>
		<form
			th:action="@{/news/edit}"
			th:object="${newsFormEditDTO}"
			method="POST"
			style="max-width: 1250px; margin: 0 auto"
			enctype="multipart/form-data"
		>
			<input
				type="hidden"
				th:field="*{id}"
			/>
			<div class="border border-secondary rounded p-3">
				<!-- Nav tabs -->
				<ul
					class="nav nav-tabs"
					id="myTab"
					role="tablist"
				>
					<li
						class="nav-item"
						role="presentation"
					>
						<button
							class="nav-link fw-bold active"
							data-bs-toggle="tab"
							data-bs-target="#overview"
							type="button"
							role="tab"
						>General Information</button>
					</li>
					<li
						class="nav-item"
						role="presentation"
					>
						<button
							class="nav-link fw-bold"
							data-bs-toggle="tab"
							data-bs-target="#shortDescription"
							type="button"
							role="tab"
						>Short Description</button>
					</li>
					<li
						class="nav-item"
						role="presentation"
					>
						<button
							class="nav-link fw-bold"
							data-bs-toggle="tab"
							data-bs-target="#mainContent"
							type="button"
							role="tab"
						>Main Content</button>
					</li>
				</ul>

				<!-- Tab panes -->
				<div class="tab-content">
					<div
						class="tab-pane p-3 active"
						id="overview"
						role="tabpanel"
					>
						<div th:replace="~{news/news_overview_edit :: content}"></div>
					</div>
					<div
						class="tab-pane"
						id="shortDescription"
						role="tabpanel"
					>
						<div th:replace="~{news/news_short_description_edit :: content}"></div>
					</div>
					<div
						class="tab-pane p-3"
						id="mainContent"
						role="tabpanel"
					>
						<div th:replace="~{news/news_main_content_edit :: content}"></div>
					</div>
				</div>
				<!-- END Tab panes -->

				<div class="text-center">
					<input
						type="submit"
						value="Save"
						class="btn btn-primary m-3"
					/>
					<input
						type="button"
						value="Cancel"
						class="btn btn-secondary"
						id="buttonCancel"
					/>
				</div>
			</div>
		</form>
		<div th:replace="~{fragments::footer}"></div>
	</div>

	<script type="text/javascript">
		const moduleURL = "[[@{/news}]]";
		const urlUploadImage = "[[@{/api/upload/news-image}]]";
		
		const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
		const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
		
		$(document).ready(function() {
			tinymce.init({
		        selector: 'textarea.tinymce-editor',
		        height: 750,
		        plugins: 'image link media table code lists',
		        toolbar: 'undo redo | bold italic underline | link image media | code | bullist numlist',
		        menubar: true,
		        automatic_uploads: true,
			    relative_urls: false,
			    remove_script_host: true,
			    convert_urls: true,
		        images_upload_handler: function(blobInfo) {
		            const file = blobInfo.blob();
		            const maxSize = 1 * 1024 * 1024; // 1MB
		
		            if (file.size > maxSize) {
		                return Promise.reject('Image file size must be less than 1MB!');
		            }
		
		            const formData = new FormData();
		            formData.append('upload', file);
		
		            return fetch(urlUploadImage, {
		                method: 'POST',
		                body: formData,
		                headers: { [csrfHeader]: csrfToken }
		            })
		            .then(response => response.json())
		            .then(data => {
		                if (data.url) {
		                    return data.url;
		                } else {
		                    return Promise.reject(data.error || 'Upload fail');
		                }
		            })
		            .catch(err => Promise.reject('Upload fail: ' + err));
		        },
		
		        file_picker_types: 'image',
		        file_picker_callback: function(callback, value, meta) {
		            if (meta.filetype === 'image') {
		                const url = prompt('Enter image URL:');
		                if (url) {
		                    callback(url, { alt: '' });
		                }
		            }
		        },
		
		        images_reuse_filename: false
		    });
		});
	</script>
	<script
		type="text/javascript"
		th:src="@{/js/common_form.js}"
	></script>
</body>
</html>